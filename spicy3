-- LocalScript đặt trong StarterGui

local Players     = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")

-- Tên file để lưu key (trên client)
local KEY_FILE = "KeySystemKey.txt"

-- Các hàm exploit thường có
local hasFile, readFile, writeFile, deleteFile = isfile, readfile, writefile, delfile

-- Đọc key cũ (nếu có)
local savedKey
if hasFile(KEY_FILE) then
    savedKey = readFile(KEY_FILE)
end

-- Hàm validate key (không load script)
local function isKeyValid(token)
    local ok, res = pcall(function()
        return game:HttpGet("https://work.ink/_api/v2/token/isValid/" .. token)
    end)
    if not ok then return false end
    local succ, data = pcall(function()
        return HttpService:JSONDecode(res)
    end)
    return succ and data.valid == true
end

-- Hàm load và lưu key
local function loadAndSave(token)
    if savedKey ~= token then
        writeFile(KEY_FILE, token)
        savedKey = token
    end
    -- load script chính
    loadstring(game:HttpGet("https://raw.githubusercontent.com/tienkhanh1/spicy/main/Chilli.lua"))()
end

-- Tạo GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "KeySystemGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = Players.LocalPlayer:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Name = "MainFrame"
frame.Size = UDim2.new(0, 300, 0, 200)
frame.Position = UDim2.new(0.5, -150, 0.5, -100)
frame.BackgroundColor3 = Color3.fromRGB(40, 44, 52)
frame.Parent = screenGui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)

-- Drag frame
local dragging, dragInput, dragStart, startPos = false
frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)
frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and input == dragInput then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end
end)

-- Tiêu đề
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,0,0,36)
title.Position = UDim2.new(0,0,0,0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 24
title.TextColor3 = Color3.fromRGB(236,240,241)
title.Text = "Key System"
title.Parent = frame

-- Input Box
local inputBox = Instance.new("TextBox")
inputBox.Size = UDim2.new(1,-24,0,36)
inputBox.Position = UDim2.new(0,12,0,50)
inputBox.PlaceholderText = "Nhập key ở đây..."
inputBox.Font = Enum.Font.Gotham
inputBox.TextSize = 18
inputBox.TextColor3 = Color3.fromRGB(236,240,241)
inputBox.BackgroundColor3 = Color3.fromRGB(54,57,63)
inputBox.ClearTextOnFocus = false
inputBox.Parent = frame
Instance.new("UICorner", inputBox).CornerRadius = UDim.new(0,8)

-- Output Label
local outputLabel = Instance.new("TextLabel")
outputLabel.Size = UDim2.new(1,-24,0,36)
outputLabel.Position = UDim2.new(0,12,0,148)
outputLabel.BackgroundTransparency = 1
outputLabel.Font = Enum.Font.Gotham
outputLabel.TextSize = 18
outputLabel.TextColor3 = Color3.fromRGB(236,240,241)
outputLabel.TextXAlignment = Enum.TextXAlignment.Center
outputLabel.Parent = frame

-- Buttons
local padding = 12
local btnW = (300 - padding*3) / 2

local getKeyBtn = Instance.new("TextButton")
getKeyBtn.Size = UDim2.new(0,btnW,0,36)
getKeyBtn.Position = UDim2.new(0,padding,0,100)
getKeyBtn.BackgroundColor3 = Color3.fromRGB(88,101,242)
getKeyBtn.Font = Enum.Font.GothamSemibold
getKeyBtn.TextSize = 18
getKeyBtn.TextColor3 = Color3.new(1,1,1)
getKeyBtn.Text = "Get Key"
getKeyBtn.Parent = frame
Instance.new("UICorner", getKeyBtn).CornerRadius = UDim.new(0,8)

local checkKeyBtn = Instance.new("TextButton")
checkKeyBtn.Size = UDim2.new(0,btnW,0,36)
checkKeyBtn.Position = UDim2.new(0,padding*2+btnW,0,100)
checkKeyBtn.BackgroundColor3 = Color3.fromRGB(46,204,113)
checkKeyBtn.Font = Enum.Font.GothamSemibold
checkKeyBtn.TextSize = 18
checkKeyBtn.TextColor3 = Color3.new(1,1,1)
checkKeyBtn.Text = "Check Key"
checkKeyBtn.Parent = frame
Instance.new("UICorner", checkKeyBtn).CornerRadius = UDim.new(0,8)

-- Logic Get Key
getKeyBtn.MouseButton1Click:Connect(function()
    setclipboard("https://workink.net/20kI/5sluirr8")  -- Thay link của bạn
    outputLabel.Text = "Link đã copy!"
end)

-- Logic Check Key (dùng chung)
local function doCheck(token)
    outputLabel.Text = "Đang kiểm tra..."
    wait(2)
    if isKeyValid(token) then
        outputLabel.Text = "Key hợp lệ!"
        wait(1)
        screenGui:Destroy()
        loadAndSave(token)
    else
        outputLabel.Text = "Key không đúng hoặc hết hạn."
        if token == savedKey then
            pcall(deleteFile, KEY_FILE)
            savedKey = nil
        end
    end
end

checkKeyBtn.MouseButton1Click:Connect(function()
    local tok = inputBox.Text:match("%S+")
    if not tok then
        outputLabel.Text = "Nhập key trước đã!"
        return
    end
    doCheck(tok)
end)

-- Nếu có savedKey, chỉ auto-fill và check chứ không ẩn Get Key
if savedKey then
    inputBox.Text = savedKey
    -- vẫn giữ getKeyBtn.Visible = true để hiển thị tự nhiên
    doCheck(savedKey)
end
